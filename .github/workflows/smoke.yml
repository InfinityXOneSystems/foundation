name: Smoke Tests
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Start Server
        run: |
          # Try different start commands
          if grep -q '"api:dev"' package.json; then
            npm run api:dev &
          elif grep -q '"api:start"' package.json; then
            npm run api:start &
          elif grep -q '"start"' package.json; then
            npm start &
          elif grep -q '"dev"' package.json; then
            npm run dev &
          else
            echo "No suitable start command found, skipping smoke tests"
            exit 0
          fi
          
          SERVER_PID=$!
          echo "Server started with PID: $SERVER_PID"
          
          # Wait for server to start
          sleep 10
        continue-on-error: false
      
      - name: Health Check
        run: |
          # Test /healthz endpoint
          if curl -f http://localhost:3000/healthz; then
            echo "✅ /healthz passed"
          else
            echo "⚠️ /healthz not available"
          fi
          
          # Test /readyz endpoint (optional)
          if curl -f http://localhost:3000/readyz; then
            echo "✅ /readyz passed"
          else
            echo "⚠️ /readyz not available (optional)"
          fi
        continue-on-error: true
      
      - name: API Smoke Tests
        run: |
          # Test /api/info endpoint
          if curl -f http://localhost:3000/api/info; then
            echo "✅ /api/info passed"
          else
            echo "⚠️ /api/info not available"
          fi
          
          # Test /api/demo/status endpoint
          if curl -f http://localhost:3000/api/demo/status; then
            echo "✅ /api/demo/status passed"
          else
            echo "⚠️ /api/demo/status not available"
          fi
        continue-on-error: true
      
      - name: Stop Server
        if: always()
        run: |
          # Kill any node processes
          pkill -f "node" || true
